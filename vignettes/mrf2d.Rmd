---
title: "A guide to mrf2d"
output: 
  rmarkdown::html_vignette:
    number_sections: true
vignette: >
  %\VignetteIndexEntry{A guide to mrf2d}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: ../inst/REFERENCES.bib
nocite: |
  @wiki_sa, @wiki_pl
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(mrf2d)
```

# Introduction

## A quick introduction to Markov Random Fields

 Markov Random Fields are probabilistic models used for modeling processes with local dependence. This dependence can be described by a graph $\mathcal{G} = (\mathcal{V}, \mathcal{N})$, where $\mathcal{V}$ is a set of vertices and $\mathcal{N}$ a neighborhood system.

$$ P_\theta(\mathbf{Z} = \mathbf{z}) = \frac{1}{\zeta_\theta} \exp \left( \sum_{q \in Q} g_q(\mathbf z_q, \theta) \right) $$

## A spatially stationary MRF model for 2-dimensional lattices

## The `mrf2d` package

`mrf2d` has the goal to provide tools for analysis of Markov Random Fields on two-dimensional lattices, mainly, by defining a well-designed representation of the interaction structure, as well as parameters sets with different types of restrictions. It also exports efficient implementations of the most commom estimation methods and a sampling function, making it easy to implement new or specific algorithms with little effort taking advantage of the the package's API.

Computational efficiency is also a feature of the package, having most of the high-cost core functions written with `Rcpp` backend and representations that were designed to have higher performance.

The package also provides [plotting](https://freguglia.github.io/mrf2d/reference/dplot.html) functions `dplot()` and `cplot()` that automatically convert `matrix` objects to appropriate `data.frame` structures and creates `ggplot` objects from it. These functions aim to provide easy to use methods of visualization but also take advantage of [`ggplot2`](https://ggplot2.tidyverse.org/)'s grammar to modify aesthetics and create elegant and customizable visualizations of lattice data. `dplot()` should be used for **d**iscrete data while `cplot()` is suitable for **c**ontinuous data.

```{r, fig.width = 4, warning=FALSE}
class(Z_potts)
unique(as.vector(Z_potts))

dplot(Z_potts, legend = TRUE)
cplot(Z_potts + rnorm(length(Z_potts)))

library(ggplot2)
dplot(Z_potts) + ggtitle("Title added with ggplot2")
dplot(Z_potts) + scale_fill_brewer(type = "qual") + 
  ggtitle("Title added with ggplot2")
```


# The `mrfi` class and parameter arrays

The stationary Markov Random Fields described are completely specified by the set of relative positions where interactions exists $\mathcal{R}$ and the interaction parameters $\theta_{a,b,r}$, $(a,b) \in \{0,\dots,C \}^2, r \in \mathcal{R}$.

In `mrf2d`, interaction structures $\mathcal{R}$ are represented by objects of the S4 class `mrfi`, while interaction parameters are reprensted by simple 3-dimensional arrays, where `theta[a,b,k]` contains the value of $\theta_{a,b,r}$ for the $k$-th relative position. As an example, in a nearest-neighbor structure ($|\mathcal{R}| = 2$) with $C = 1$, where the interaction for equal values ($a=b$) is `0` and `-0.99` for different values, the corresponding array would be

```{r}
mrf2d:::vec_to_array(-0.99, "onepar", 1, 2)
```

Note how rows represents values $a$, columns are values of $b$ and slices are the relative positions in $\mathcal{R}$.

## Creating `mrfi` objects

`mrfi` objects can be created with the `mrfi()` function. It takes three parameters: `max_norm`, `norm_type` and `positions`. `max_norm` and `norm_type` combined define a region where interactions are included. As example, if `max_norm` is `3` and `norm_type` is `"1"`, the interaction structure will include relative positions $r$ where $|r_x| + |r_y| \leq 3$.

Note that opposite positions, e.g., $(1,0)$ and $(-1,0)$ are not both included, as the second one is always redundant for the model. A `plot()` function is available to visualize

```{r}
mrfi(max_norm = 3, norm_type = "1")
```


## Parameter restriction families

### family `'onepar'`

The interaction depends only if the pair of values is equal or different and not on their values or relative position. Since we set $\theta_{0,0,r} = 0$, this simplifies as:

$$ \theta_{a,b,r} = \theta \mathbb{1}_{[a \neq b]} $$

Example of valid array for `'onepar'`:

```{r, echo = FALSE}
mrf2d:::vec_to_array(-0.01, family = "onepar", C = 2, 2)
```


### family `'oneeach'`

The same as `'onepar'`, but allowing different values for different relative positions $r$:

$$ \theta_{a,b,r} = \theta_r \mathbb{1}_{[a \neq b]} $$

Example of valid array for `'oneeach'`:

```{r, echo = FALSE}
mrf2d:::vec_to_array(c(-0.01, -0.02), family = "oneeach", C = 2, 2)
```

### family `'absdif'`

```{r, echo = FALSE}
mrf2d:::vec_to_array(c(-0.01, -0.02, -0.03, -0.04), family = "absdif", C = 2, 2)
```

### family `'dif'`

```{r, echo = FALSE}
mrf2d:::vec_to_array(c(-0.01, -0.02, -0.03, -0.04, -0.05, -0.06, -0.07, -0.08), family = "dif", C = 2, 2)
```

### family `'free'`

```{r, echo = FALSE}
mrf2d:::vec_to_array(seq(-0.01, -0.16, by = -0.01), family = "free", C = 2, 2)
```

# Parameter estimation on Markov Random Fields

## Pseudo-Likelihood

$$ PL(\theta;\mathbf{z}) = \prod_{i \in \mathcal{L}} P(Z_i = z_i | \mathbf{Z}_{\mathcal{N}_i} = \mathbf{z}_{\mathcal{N}_i}) $$

## Stochastic Approximation

# Hidden Markov Random Fields

## Corrupted discrete image model

## Gaussian Mixtures

@zhang2001segmentation

$$ f(\mathbf{y}|\mathbf{Z} = \mathbf{z}) = \prod_{i \in \mathcal{L}} \frac{1}{\sqrt{2\pi \sigma^2}} \exp \left( - \frac{(y_i - \mu_{Z_i})^2}{2\sigma^2} \right) $$

# Bibliography
